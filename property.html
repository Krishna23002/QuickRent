<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickRent - Property Details</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <nav>
        <h1>QuickRent</h1>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="browse.html">Browse Property</a>
            <a href="list.html">List Property</a>
            <a href="about.html">About</a>
            <div class="auth-btn">
                <button onclick="goToLoginPage('login')" class="primary-btn login">Login</button>
                <button onclick="goToLoginPage('signup')" class="primary-btn signUp">Sign Up</button>
            </div>
            <div class="user-menu" style="display: none;">
                <div class="dropdown">
                    <button class="dropdown-btn">
                        <i class="fas fa-user"></i> <span id="username"></span>
                    </button>
                    <div class="dropdown-content">
                        <a href="profile.html" id="profile-link">Profile</a>
                        <a href="notifications.html" id="notifications-link" style="display: none;">Notifications</a>
                        <a href="admin.html" id="admin-link" style="display: none;">Admin Panel</a>
                        <a href="#" onclick="logout()">Logout</a>
                    </div>
                </div>
            </div>

        </div>
    </nav>

    <section class="property-details-container">
        <div id="property-details" class="property-details">
            <!-- Property details will be loaded here -->
        </div>
    </section>

    <!-- Booking Modal -->
    <div id="booking-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeBookingModal()">&times;</span>
            <h3>Book This Property</h3>
            <form id="booking-form">
                <label>Start Date:</label>
                <input type="date" id="start-date" required>

                <label>End Date:</label>
                <input type="date" id="end-date" required>

                <label>Message to Owner (Optional):</label>
                <textarea id="message" placeholder="Write a message..."></textarea>

                <button type="submit" class="btn-primary">Submit Booking</button>
            </form>
        </div>
    </div>


    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-brand">
                <h3>QuickRent</h3>
                <p>Find verified homes for students and professionals with ease.</p>
            </div>
            <div class="footer-links">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="browse.html">Browse</a></li>
                    <li><a href="about.html">About</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h4>Contact</h4>
                <ul>
                    <li><i class="fas fa-envelope"></i> support@quickrent.com</li>
                    <li><i class="fas fa-phone"></i> +91 98765 43210</li>
                    <li><i class="fas fa-map-marker-alt"></i> Mumbai, India</li>
                </ul>
            </div>
            <div class="footer-social">
                <h4>Follow Us</h4>
                <div class="social-icons">
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <span>© <span id="year">2025</span> QuickRent. All rights reserved.</span>
        </div>
    </footer>

    <script src="script.js"></script>

    <script>
        // Get propertyId from URL ?id=<propertyId>
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('id');



       async function loadPropertyDetails() {
    if (!propertyId) {
        document.getElementById('property-details').innerHTML = "<p>Property not found.</p>";
        return;
    }

    try {
        const response = await fetch(`https://new-eaor.onrender.com/api/properties/${propertyId}`);

        let data;
        try {
            data = await response.json();
        } catch {
            document.getElementById('property-details').innerHTML = "<p>Invalid server response</p>";
            return;
        }

        if (!response.ok) {
            document.getElementById('property-details').innerHTML =
                `<p>${data?.message || 'Property not found'}</p>`;
            return;
        }

        const p = data.property;
        const rawPhone = p.owner?.phone || '+91 98765 43210';
        const rawEmail = p.owner?.email || 'owner@quickrent.com';
        const isLoggedIn = !!localStorage.getItem('token');
        const displayPhone = (() => {
          if (isLoggedIn) return rawPhone;
          const s = String(rawPhone).replace(/\D/g, '');
          if (s.length >= 4) {
            const last4 = s.slice(-4);
            const masked = '••••••••' + last4;
            return masked;
          }
          return '••••';
        })();
        const displayEmail = (() => {
          if (isLoggedIn) return rawEmail;
          const [user, domain] = String(rawEmail).split('@');
          if (!user || !domain) return '••••@••••';
          const visible = user.slice(0, 2);
          return `${visible}${'•'.repeat(Math.max(0, user.length - 2))}@${domain}`;
        })();
        const locationText = [p.city, p.state, p.pincode].filter(Boolean).join(', ');
       document.getElementById('property-details').innerHTML = `
<div class="property-detail-page">
  <div class="property-header">
    <a href="browse.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Property List</a>
  </div>

  <div class="property-hero">
    <div class="image-carousel">
      <button class="prev">&#10094;</button>
      <div class="carousel-images">
        ${p.images?.map(img => `<img src="https://new-eaor.onrender.com${img}" alt="${p.title}" onerror="this.src='uploads/images-1758729208348-875584086.avif'">`).join('')}
      </div>
      <button class="next">&#10095;</button>
    </div>
  </div>

  <div class="property-content">
    <div class="property-status">${p.type}</div>
    <h3 class="property-title">${p.title}</h3>
    <p class="property-address"><i class="fas fa-map-marker-alt"></i> ${locationText}</p>

    <div class="property-price-rating">
      <h3 class="price">₹${(p.price || 0).toLocaleString()}</h3>
      <div class="rating"><i class="fas fa-star"></i> 4.8 <span>(3150+)</span></div>
    </div>

    <p class="property-description">${p.description || 'Beautiful property available for rent.'}</p>

    <div class="property-facts">
      <div><i class="fas fa-bed"></i> ${p.bedrooms || 0} Beds</div>
      <div><i class="fas fa-bath"></i> ${p.bathrooms || 0} Baths</div>
      <div><i class="fas fa-layer-group"></i> ${p.totalFloors || 1} Floors</div>
      <div><i class="fas fa-ruler-combined"></i> ${(p.area || null)} sq.ft.</div>
      <div><i class="fas fa-compass"></i> Facing: ${p.facing || 'N/A'}</div>
      <div><i class="fas fa-building"></i> Type: ${p.type || 'Apartment'}</div>
        <div><i class="fas fa-user-friends"></i> Roommate Required: ${p.roommateRequired ? 'Yes' : 'No'}</div>
    </div>

    <div class="property-amenities">
      <h4>Amenities:</h4>
      <div class="amenity-tags">
        ${Array.isArray(p.amenities) && p.amenities.length > 0 ? 
          p.amenities.map(a => `<span class="amenity-tag">${a}</span>`).join('') : 
          '<p>No amenities listed.</p>'}
      </div>
    </div>

     <!-- Owner Details -->
    <div class="owner-section">
      <h4>Owner Information</h4>
      <div class="owner-card">
        <div class="owner-info">
          <h5>${p.owner?.name || 'Property Owner'}</h5>
          <p><i class="fas fa-phone"></i> ${displayPhone}</p>
          <p><i class="fas fa-envelope"></i> ${displayEmail}</p>
          <p class="owner-bio">${p.owner?.bio || 'Friendly and responsive owner who ensures a comfortable stay.'}</p>
        </div>
      </div>
    </div>

    <button class="btn-primary" onclick="bookProperty('${p._id}')">Book Now</button>
  </div>
</div>
`;


                // Initialize carousel AFTER images are in DOM
                initCarousels();

    } catch (err) {
        console.error(err);
        document.getElementById('property-details').innerHTML = "<p>Error loading property details.</p>";
    }
}


        function bookProperty(id) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Please log in to book this property.");
                return;
            }

            // optional: verify token with backend
            try {
                const decoded = JSON.parse(atob(token.split('.')[1]));
                const exp = decoded.exp * 1000;
                if (Date.now() >= exp) {
                    alert("Session expired. Please log in again.");
                    localStorage.removeItem("token");
                    return;
                }
            } catch {
                alert("Invalid session. Please log in again.");
                localStorage.removeItem("token");
                return;
            }

            window.selectedPropertyId = id;
            document.getElementById("booking-modal").style.display = "flex";
        }


        function closeBookingModal() {
            document.getElementById("booking-modal").style.display = "none";
            document.getElementById("booking-form").reset();
        }

        document.getElementById("booking-form").addEventListener("submit", async function (e) {
            e.preventDefault();

            const startDate = document.getElementById("start-date").value;
            const endDate = document.getElementById("end-date").value;
            const message = document.getElementById("message").value;
            const token = localStorage.getItem("token");

            if (!startDate || !endDate) {
                alert("Please select valid dates.");
                return;
            }

            try {
                const response = await fetch("https://new-eaor.onrender.com/api/bookings", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        propertyId: window.selectedPropertyId,
                        startDate,
                        endDate,
                        message
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert("Booking request sent successfully!");
                    closeBookingModal();
                } else {
                    alert("Failed to book property: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("Error sending booking request. Try again later.");
            }
        });


        function initCarousels() {
            const carousels = document.querySelectorAll('.image-carousel');

            carousels.forEach(carousel => {
                const imagesContainer = carousel.querySelector('.carousel-images');
                const images = carousel.querySelectorAll('img');
                const prevBtn = carousel.querySelector('.prev');
                const nextBtn = carousel.querySelector('.next');
                let index = 0;

                function showImage(i) {
                    if (i < 0) index = images.length - 1;
                    else if (i >= images.length) index = 0;
                    else index = i;
                    imagesContainer.style.transform = `translateX(-${index * 100}%)`;
                }

                prevBtn.addEventListener('click', () => showImage(index - 1));
                nextBtn.addEventListener('click', () => showImage(index + 1));

                showImage(0);
            });
        }

        loadPropertyDetails();

    </script>
    
</body>

</html>
